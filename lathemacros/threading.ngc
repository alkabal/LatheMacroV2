;threading
O<threading> sub

#<_backup_metric> = #<_metric>
#<_backup_absolute> = #<_absolute>
#<_backup_feed> = #<_feed>
#<_backup_ccomp> = #<_ccomp>
#<_backup_tool_offset> = #<_tool_offset>
#<_backup_coord_system> = #<_coord_system>
#<_backup_ijk_abs_mode> = #<_ijk_absolute_mode>
o1 if [#<_ini[DISPLAY]LATHE>]
   #<_backup_lathe_diam_mode> = #<_lathe_diameter_mode>
   #<_backup_lathe_mode> = 1
o1 else
   #<_backup_lathe_mode> = 0
o1 endif

G8  ; Lathe radius Mode
G90 ; Absolute Distance

#<X_coord>     = #<X_coord>
#<feed_rpm>    = #<feed_rpm>
#<tool_number> = #<tool_number>
#<pitch>       = #<pitch>
#<Z_coord>     = #<Z_coord>
#<interior>    = #<interior>
#<exterior>    = #<exterior>
#<coolant>     = #<coolant>

;M6 T#<tool_number> G43
        O100 if [#<coolant> NE #<_current_tool>]
             (MSG,ERROR : Set tool before use macro)
             o<restore> call     ; restore g20/21, g90/g91, feedrate cuter-comp and other using now global _backup_var
        O100 return [-2] ; indicate failure to epilog
        O100 endif

#<X_coord> = [#<X_coord> / 2.0]
#<starting_X> = [#<_x> * 2] (starting X)
#<starting_Z> = #<_z> (starting Z)
G96 D2500 S#<feed_rpm> ; Constant Surface Speed Mode
M3            ; Start Spindle
G4 P1         ; Wait to reach speed

        O110 if [#<coolant>]
                M8
        O110 endif

#<height> = [0.86603 * #<pitch>]
#<majorflat> = [#<height> * 0.125]
#<minorflat> = [#<height> * 0.250]
#<threaddepth> = [#<height> * 0.625]
;(DEBUG,#<height> #<majorflat> #<minorflat> #<threaddepth>)

        O200 if [#<_metric>]
            #<cutdepth> = 0.2
            #<flatfeed> = 0.1
        O200 else
            #<cutdepth> = 0.007
            #<flatfeed> = 0.004
        O200 endif

G95 F#<flatfeed> ; Feed-Per-Rev Mode

;Threading
        O300 if [#<interior> GT 0.5] ;internal
            ;cut the minor flat diameter
            ;(DEBUG,INTERNAL Threading thread dia-#<X_coord> startZ-#<starting_Z> finishZ-#<Z_coord> Pitch-#<pitch> Tool-#<tool_number>)
            G0 Z #<starting_Z>
            G0 X [#<X_coord> + #<minorflat> - #<height>]
            G1 Z #<Z_coord>
            G0 X [#<X_coord> - #<height>]
            G0 Z #<starting_Z>
            G96 D600 S#<feed_rpm> ; limit RPM in threading mode
            G76 P#<pitch> Z#<Z_coord> i#<minorflat> j#<cutdepth> k#<threaddepth> H3 R1.5 Q29.5 E0 L0
            G0 X [#<X_coord> - 0.5]
        O3001 else ;external
            ; cut the major diameter
            ;(DEBUG,EXTERNAL Threading thread dia-#<X_coord> startZ-#<starting_Z> finishZ-#<Z_coord> Pitch-#<pitch> Tool-#<tool_number> MF #<majorflat>)
            G0 Z #<starting_Z>
            G0 X #<X_coord>
            G1 X [#<X_coord> - #<majorflat>]
            G1 Z #<Z_coord>
            G0 X #<X_coord>
            G0 Z #<starting_Z>
            G96 D600 S#<feed_rpm> ; limit RPM in threading mode
            G76 P#<pitch> Z#<Z_coord> i[-#<majorflat>] j#<cutdepth> k#<threaddepth> H3 R1.5 Q29.5 E0 L0
            G0 X [#<X_coord> + 0.5]
        O300 endif

        G0 Z#<starting_Z>

M5
M9

  o<restore> call     ; restore g20/21, g90/g91, feedrate cuter-comp and other using now global _backup_var

O<threading> endsub

M2
%
