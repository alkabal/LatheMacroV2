;drill
O<drill> sub

#<_backup_metric> = #<_metric>
#<_backup_absolute> = #<_absolute>
#<_backup_feed> = #<_feed>
#<_backup_ccomp> = #<_ccomp>
#<_backup_tool_offset> = #<_tool_offset>
#<_backup_coord_system> = #<_coord_system>
#<_backup_ijk_abs_mode> = #<_ijk_absolute_mode>
o1 if [#<_ini[DISPLAY]LATHE>]
   #<_backup_lathe_diam_mode> = #<_lathe_diameter_mode>
   #<_backup_lathe_mode> = 1
o1 else
   #<_backup_lathe_mode> = 0
o1 endif

G7  ; diameter mode
G90 ; Absolute Distance

#<drill_diam>     = #1
#<Y_depth>        = #2
#<speed>          = #3
#<feed_rpm>       = #4
#<tool_number>    = #5
#<peck_amount>    = #6
#<retract_amount> = #7
#<coolant>        = #8

#<starting_Y> = #<_y> (starting Y)

;M6 T#<tool_number> G43
        O100 if [#<tool_number> NE #<_current_tool>]
             (MSG,ERROR : Set tool before use macro)
             o<restore> call     ; restore g20/21, g90/g91, feedrate cuter-comp and other using now global _backup_var
        O100 return [-2] ; indicate failure to epilog
        O100 endif

#<speed_calc> = [[1000 * #<speed>] / [3.1415 * #<drill_diam>]] ; metric mode RPM

G97 S#<speed_calc> ; Constant RPM mode
M3                ; Start Spindle
G95 F#<feed_rpm>  ; Feed-Per-Rev Mode
G4 P1             ; Wait to reach speed

        O110 if [#<coolant>]
                M8
        O110 endif

(DEBUG,Drilling dia-#<drill_diam> depth-#<Y_depth> asked-speed-#<speed> feed/rpm-#<feed_rpm> tool-#<tool_number> peck dist-#<peck_amount> retract amount-#<retract_amount> calculated-rpm-#<speed_calc> start-Y-#<starting_Y>)
(MSG,ERROR : TODO must retract the X axis to home position)
; G0 X0 ; TODO must retract the X axis to home position
;G0 Y#<starting_Y>
G98
G83 Y#<Y_depth> R#<starting_Y> Q#<peck_amount>
G80
;G0 Y#<starting_Y>

M5
M9

  o<restore> call     ; restore g20/21, g90/g91, feedrate cuter-comp and other using now global _backup_var

O<drill> endsub

M2
%
